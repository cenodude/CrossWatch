# CrossWatch Developer Guide

Welcome to **CrossWatch** â€” a modular system for synchronizing watchlists and metadata
across providers such as Plex and SIMKL.

This guide is for developers who want to understand the **project structure**,
**modular architecture**, and how to extend or debug the system.

---

## ğŸ“‚ Project Structure

```
root/
â”œâ”€â”€ crosswatch.py         # FastAPI backend entrypoint
â”œâ”€â”€ _FastAPI.py           # HTML template (injects assets, containers)
â”œâ”€â”€ _logging.py           # Central logging utilities (ANSI colors, JSON sink)
â”œâ”€â”€ _statistics.py        # Sync statistics engine (diffs, counters, events)
â”œâ”€â”€ _TMDB.py              # TMDb API integration (posters, metadata)
â”œâ”€â”€ _watchlist.py         # Watchlist utilities (grid, Plex API helpers)
â”‚
â”œâ”€â”€ assets/
â”‚   â”œâ”€â”€ crossover.css     # Frontend styles
â”‚   â””â”€â”€ crossover.js      # Frontend logic (auth cards, run sync, status)
â”‚
â”œâ”€â”€ auth/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ _auth_base.py     # AuthProvider protocol + AuthStatus/AuthManifest
â”‚   â”œâ”€â”€ _auth_PLEX.py     # Plex device PIN auth flow
â”‚   â””â”€â”€ _auth_SIMKL.py    # SIMKL OAuth auth flow
â”‚
â”œâ”€â”€ modules/
â”‚   â”œâ”€â”€ _mod_base.py      # SyncModule protocol + SyncContext/SyncResult
â”‚   â”œâ”€â”€ _mod_PLEX.py      # Plex sync implementation
â”‚   â””â”€â”€ _mod_SIMKL.py     # SIMKL sync implementation
â”‚
â””â”€â”€ platform/
    â”œâ”€â”€ manager.py        # PlatformManager: unified auth + sync profiles
    â””â”€â”€ orchestrator.py   # Orchestrator: runs sync profiles via modules
```

---

## ğŸ§© Core Concepts

### PlatformManager
- Discovers **auth providers** from `auth/_auth_*.py`
- Provides:
  - `/api/platform/providers` â†’ manifests + status + capabilities
  - `/api/platform/auth/*` â†’ start/finish/refresh/disconnect
  - `/api/platform/sync/options` â†’ compute valid feature sets
  - `/api/platform/sync/profiles` â†’ save/load sync profiles

### Orchestrator
- Reads sync profiles from PlatformManager
- Maps `(source, target)` â†’ module class (e.g. PLEXâ†’SIMKL)
- Runs selected features (`watchlist`, `ratings`, `watched`, etc.)
- Persists snapshots to config/state for delta sync

### Modules (`/modules`)
- Each `_mod_*.py` implements the `SyncModule` protocol
- Defines:
  - `run_sync(SyncContext)` â†’ executes sync
  - `supported_features()` (optional) â†’ declare capabilities

### Auth Providers (`/auth`)
- Each `_auth_*.py` implements the `AuthProvider` protocol
- Defines:
  - `manifest()` â†’ label, flow type (`oauth`, `device_pin`, etc.), fields, actions
  - `capabilities()` â†’ what features the provider supports
  - `get_status()`, `start()`, `finish()`, `refresh()`, `disconnect()`

---

## ğŸ–¥ï¸ Frontend (assets/)
- `crossover.js` dynamically renders **auth cards** and wires buttons to `/api/platform/*`
- `crossover.css` styles the cards, badges, and sync grid
- UI is **provider-agnostic**: adding a new `_auth_*.py` automatically shows up

---

## ğŸªµ Logging
- Use `from _logging import log`
- Flexible API:
  ```python
  log("message", level="INFO", module="AUTH", extra={"provider": "SIMKL"})
  ```
- Supports ANSI colors (stdout) and optional JSON logs

---

## ğŸ“Š Statistics
- `_statistics.py` compares old/new states
- Tracks counts (added, removed, updated) and timeline events
- Feeds into insights dashboard in the web UI

---

## ğŸŒ External APIs
- **Plex**: Device PIN login, watchlist, collections
- **SIMKL**: OAuth2 login, watchlist, ratings, watched
- **TMDb**: Metadata enrichment (art, runtime, tagline, etc.)

---

## ğŸš€ Development Workflow
1. Clone repo and build dev container:
   ```bash
   docker build -t crosswatch-dev .
   docker run --rm -it -p 8787:8787 -v $PWD/config:/config crosswatch-dev
   ```
2. Visit `http://localhost:8787` to open the web UI.
3. Add providers under **Settings â†’ Authentication**.
4. Create sync profiles under **Settings â†’ Sync Profiles**.
5. Run sync via the **Run** button or API:
   ```bash
   curl -X POST http://localhost:8787/api/platform/sync/run -d '{"id":"PLEXâ†’SIMKL"}'
   ```

---

## ğŸ§‘â€ğŸ’» Extending CrossWatch

### Add a new auth provider
1. Create `auth/_auth_NEWPROVIDER.py`
2. Export `PROVIDER = NewProviderAuth()`
3. Implement `AuthProvider` methods
4. Add `capabilities()` so sync engine knows what features are available

### Add a new sync module
1. Create `modules/_mod_NEWPROVIDER.py`
2. Implement `SyncModule` protocol with `run_sync()`
3. Register it in `platform/orchestrator.py`:
   ```python
   self.registry[("PLEX", "NEWPROVIDER")] = NewProviderModule
   ```

---

## âœ… Conventions
- **File naming**: `_auth_NAME.py`, `_mod_NAME.py`
- **Logger**: always use `_logging.log` instead of `print`
- **Profiles**: saved under `/config/profiles.json`
- **State**: snapshots persisted to `/config/state.json`
- **Config**: tokens, keys in `/config/config.json`

---

Happy hacking!  
_The CrossWatch Team_
