# Analyzer – what it is, what you need, how to use it

Analyzer looks at your **CrossWatch runtime state** and tries to answer one question:
> *“Which items did not sync, and why?”*

It scans your libraries, finds **unsynced items and ID problems**, and tells you **where** to fix them (usually **in Plex/Jellyfin/Emby**).  
There is NO “fix all my metadata” magic, just focused pointers so you know what to change.

---
## What does it actually do?

### 1. Inventory
Analyzer reads `state.json` and builds an inventory per provider and feature:

- **Providers**: PLEX, JELLYFIN, EMBY, SIMKL, TRAKT, MDBLIST  
- **Features**: `history`, `watchlist`, `ratings`

### 2. Pair-aware issue detection
It then uses your configured `pairs` to find **real sync gaps**, not just random differences.

It can flag:

- `missing_peer`  
  Item exists at the source but **no matching item** exists on any active target for that pair  
  (e.g. `PLEX → SIMKL` history item that never shows up on SIMKL).
- `missing_ids`  
  Core IDs (IMDb/TMDb/TVDb) are missing, while other IDs are present.
- `invalid_id_format`  
  ID looks wrong (e.g. IMDb without the `tt` prefix, or junk instead of a number).
- `key_missing_ids`  
  Key claims e.g. `tmdb:123` but the actual `tmdb` field is empty.
- `key_ids_mismatch`  
  Key and field disagree (e.g. key says `tmdb:123` but the `tmdb` field is `456`).

Only **enabled pairs and features** are considered. If a pair/feature is off, its items are not treated as issues.

### 3. Suggestions (best effort)
When you select an unsynced item (`missing_peer`), Analyzer tries to propose IDs:

- From **peers**  
  Other providers with the **same title/year/type** in your state.
- From the **key**  
  If the item key looks like `tmdb:123#…`, that becomes a candidate `tmdb` value.
- From **TMDb** (if `tmdb.api_key` is configured)  
  - Direct `find` by IMDb ID  
  - Search by title/year (movie / TV / episode) and then external IDs.
- From **Trakt** (if `trakt.client_id` is configured)  
  - Title/year search for movie/show/episode.

Results are deduplicated so equivalent candidates (same ID combo) don’t spam the list.

> Important: Suggestions are **hints**, not guarantees. Always sanity-check before trusting them.

---
## What do I need?
- A valid `state.json` generated by a recent sync run.
- The PAIR should be _enabled_
- Optional, but recommended:
  - **TMDb API key** (`tmdb.api_key` in `config.json`)  
  - **Trakt client_id** (+ token) for richer lookups

Without TMDb/Trakt keys you still get:
- Peer-based hints (from your other providers)
- Key-based hints (from the item key itself)

Just fewer “smart” guesses.

---
## How to use the UI

1. Open **Analyzer** from the UI.
2. At the top you’ll see:
   - **Pair chips**: `PLEX ⇄ JELLYFIN`, `PLEX → SIMKL`, `PLEX → MDBLIST`, `PLEX → TRAKT`, …
   - A **Scope** toggle: `Scope: issues` / `Scope: all`
   - Controls for **IDs shown/hidden**, **search**, and **Analyze**.

![Analyzer – top controls](https://github.com/user-attachments/assets/99bf39b0-4b69-437b-9229-ef3da29590d8)

### Pair chips

![Analyzer – pair chips](https://github.com/user-attachments/assets/3c35c706-54db-4ef5-8e1a-80555dada235)

- Click a chip to focus on that pair only.  
  Example: select `PLEX → MDBLIST` → the grid only shows items relevant for that pair.
- Clicking again can switch between:
  - Single-pair focus
  - “All pairs” mode

### Scope
- `Scope: issues`  
  Shows only items with `missing_peer` for the **active pairs**.
- `Scope: all`  
  Shows all items from `state.json` for the active pairs, even if they are already synced.

### Grid

The main table shows:
![Analyzer – grid](https://github.com/user-attachments/assets/f1808fc6-a1d0-4a2f-b97e-a19a04580089)

- **Provider**, **Feature**, **Title**, **Year**, **Type**
- A red dot for items with **missing peers**.
- You can:
  - **Sort** by clicking headers.
  - **Search** by title/year/provider/feature/type.
  - **Resize** the list/detail split; the position is remembered.

### Detail panel

Click a row to open its detail:

![Analyzer – detail panel](https://github.com/user-attachments/assets/58332ee3-b31e-410e-9b28-ca8406a248f2)

- A short explanation of what’s likely wrong and **where to fix it** (Plex/Jellyfin/Emby vs tracker).
- Up to 5 best suggestions with:
  - Source (`peers`, `key`, `tmdb`, `trakt`)
  - Confidence percentage
  - Proposed IDs as chips.

### Manual IDs editor

At the bottom of the detail panel is **Manual IDs**:

![Analyzer – manual IDs editor](https://github.com/user-attachments/assets/aace0d4f-a8cd-46fb-a8b7-b75700f8f0b5)

- Inline fields for `imdb`, `tmdb`, `tvdb`, `trakt`, `plex`, `simkl`, `emby`, `mdblist`.
- **Save IDs**:
  - Normalises values (IMDb prefixed with `tt`, numeric TMDb/TVDb/etc.).
  - Rekeys the item when possible.
  - Re-evaluates whether it still counts as a `missing_peer`.
- **Reset**:
  - Restores IDs from the original `state.json` entry.

---

## Where do I fix stuff?

Short version: **fix at the source of the pair.**

### Media server → tracker

For pairs like:
- `PLEX/JELLYFIN/EMBY → SIMKL`
- `PLEX/JELLYFIN/EMBY → TRAKT`
- `PLEX → MDBLIST`

You typically:

1. Use **Match** / metadata edit in Plex/Jellyfin/Emby.
2. Make sure **IMDb/TMDb/TVDb IDs** and year/title are correct.
3. Optionally use Analyzer’s suggestions to pick the right IDs.
4. Run a **sync** again.

### Tracker-only items
For stuff that lives only on SIMKL/TRAKT/MDBLIST:

- Analyzer **does not edit** those services.
- Decide whether to:
  - Import/add the title to your media server, or
  - Remove/clean it at the tracker side if it’s junk.

---

## Issue types

| Type                | Meaning                                       | Do this                                                          |
|---------------------|-----------------------------------------------|------------------------------------------------------------------|
| `missing_peer`      | No counterpart at target per your pairs       | Fix IDs/match in source (usually Plex/Jellyfin/Emby) and resync |
| `missing_ids`       | IMDb/TMDb/TVDb missing, others present        | Set core IDs at the source, then resync                         |
| `invalid_id_format` | ID looks invalid                              | Normalise (e.g. `tt1234567` for IMDb, plain number for TMDb/TVDb) |
| `key_missing_ids`   | Key says e.g. `tmdb:123` but field is empty   | Copy that ID into the item’s IDs                                |
| `key_ids_mismatch`  | Key ≠ field (TMDb:123 vs field=456)           | Make key and field agree (pick the correct one)                 |

---

## What can I actually do with this?

- **Triage fast**  
  Filter by pair/provider/feature and work through the `missing_peer` list first.

- **Fill IDs smartly**  
  Use suggested IDs or manual editor, update Plex/Jellyfin/Emby, and re-run sync until the item disappears from issues.

- **Validate your setup**  
  Check that the total number of issues makes sense given your pairs (no more giant walls of false positives).

- **Audit ratings (optional)**  
  Use the `ratings-audit` endpoint to inspect rating data across providers.

---
## Troubleshooting

- **Issues count looks way too high**  
  - Check your `pairs` in `config.json`.  
  - Only `missing_peer` items **for enabled pairs/features** count as issues.
- **No suggestions for an item**  
  - Make sure TMDb and/or Trakt keys are configured if you want external lookups.  
  - You will still get peer/key hints even without them.
- **Same issue keeps coming back after sync**  
  - Source metadata is probably still wrong (ID or year).  
  - Refresh metadata in Plex/Jellyfin/Emby, confirm the IDs, and rerun sync.